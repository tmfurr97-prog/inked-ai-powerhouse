/**
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model where all user-generated
 * content is private and accessible only to the authenticated user who created it.
 * The security model is designed to be highly secure from an authorization standpoint
 * while remaining flexible on data shapes to support rapid prototyping.
 *
 * Data Structure:
 * All user data is hierarchically organized under the `/users/{userId}` path. This
 * structure naturally isolates each user's data (novels, courses, form templates, etc.)
 * from all other users, simplifying security logic and query performance.
 *
 * Key Security Decisions:
 * - Strict Ownership: Access to any document or subcollection is granted only if
 *   the requesting user's UID matches the `{userId}` in the document's path.
 * - No User Listing: Listing documents from the root `/users` collection is
 *   prohibited to protect user privacy and prevent data scraping.
 * - Path Integrity: Upon creation, we enforce that key identifier fields within a
 *   document's data (e.g., `userId`, `novelId`) match the corresponding IDs in the
 *   path. This ensures data consistency and prevents documents from being
 *   created in the wrong user's data tree or under the wrong parent.
 * - Immutability of Ownership: Critical relational fields (like `userId` or `novelId`)
 *   are immutable and cannot be changed after a document is created.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId from the path.
     * This is the primary function for enforcing the ownership model.
     * @param userId The user ID from the document path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Ensures an operation is performed by the owner on an existing document.
     * Crucial for all update and delete operations to prevent modifying non-existent data.
     * @param userId The user ID from the document path.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that a user profile document being created has its internal 'id'
     * field correctly set to match the user's UID.
     * @param userId The user ID from the document path.
     */
    function createsOwnProfile(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }
    
    /**
     * Validates that the internal 'id' of a user profile is not changed on update.
     */
    function updatesOwnProfile() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a child document (e.g., Novel, Course) being created has its
     * internal 'userId' field set to the owner's UID from the path.
     * @param userId The user ID from the document path.
     */
    function createsOwnChild(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    /**
     * Validates that the internal 'userId' of a child document is not changed on update.
     */
    function updatesOwnChild() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    /**
     * Validates that a nested document (e.g., Chapter, Module) being created has its
     * parent ID field correctly set to match the parent ID from the path.
     * @param parentId The parent document ID from the path.
     * @param parentKey The name of the foreign key field in the document data.
     */
    function createsNestedChild(parentId, parentKey) {
      return request.resource.data[parentKey] == parentId;
    }

    /**
     * Validates that the parent ID of a nested document is not changed on update.
     * @param parentKey The name of the foreign key field in the document data.
     */
    function updatesNestedChild(parentKey) {
      return request.resource.data[parentKey] == resource.data[parentKey];
    }

    // -------------------------------------------------------------------------
    // User Profile Rules
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow An authenticated user (auth.uid='user123') can (create) their own profile at `/users/user123`.
     * @deny An authenticated user (auth.uid='user123') cannot (update) another user's profile at `/users/user456`.
     * @principle Enforces that users can only create and manage their own profile document. User listing is denied.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if createsOwnProfile(userId);
      allow update: if isExistingOwner(userId) && updatesOwnProfile();
      allow delete: if isExistingOwner(userId);
    }

    // -------------------------------------------------------------------------
    // Novels & Chapters
    // -------------------------------------------------------------------------

    /**
     * @description Manages novels created by a user.
     * @path /users/{userId}/novels/{novelId}
     * @allow A user (auth.uid='user123') can (create) a novel in their own collection at `/users/user123/novels/novelABC`.
     * @deny A user (auth.uid='user123') cannot (get) a novel from another user's collection at `/users/user456/novels/novelXYZ`.
     * @principle Restricts all access to a user's own data tree and validates relational integrity on write.
     */
    match /users/{userId}/novels/{novelId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if createsOwnChild(userId);
      allow update: if isExistingOwner(userId) && updatesOwnChild();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages chapters within a user's novel.
     * @path /users/{userId}/novels/{novelId}/chapters/{chapterId}
     * @allow A user (auth.uid='user123') can (list) all chapters for their own novel at `/users/user123/novels/novelABC`.
     * @deny A user (auth.uid='user123') cannot (create) a chapter in another user's novel.
     * @principle Access is inherited from the parent document's ownership. Enforces path consistency.
     */
    match /users/{userId}/novels/{novelId}/chapters/{chapterId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && createsNestedChild(novelId, 'novelId');
      allow update: if isExistingOwner(userId) && updatesNestedChild('novelId');
      allow delete: if isExistingOwner(userId);
    }

    // -------------------------------------------------------------------------
    // Business Form Templates
    // -------------------------------------------------------------------------

    /**
     * @description Manages business form templates created by a user.
     * @path /users/{userId}/businessFormTemplates/{formId}
     * @allow A user (auth.uid='user123') can (create) a template at `/users/user123/businessFormTemplates/formABC`.
     * @deny A user (auth.uid='user123') cannot (delete) a template at `/users/user456/businessFormTemplates/formXYZ`.
     * @principle Restricts all access to a user's own data tree and validates relational integrity on write.
     */
    match /users/{userId}/businessFormTemplates/{formId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if createsOwnChild(userId);
      allow update: if isExistingOwner(userId) && updatesOwnChild();
      allow delete: if isExistingOwner(userId);
    }

    // -------------------------------------------------------------------------
    // Courses, Modules, and Lessons
    // -------------------------------------------------------------------------

    /**
     * @description Manages courses created by a user.
     * @path /users/{userId}/courses/{courseId}
     * @allow A user (auth.uid='user123') can (list) all courses they created under `/users/user123/courses`.
     * @deny A user (auth.uid='user123') cannot (get) a course from another user at `/users/user456/courses/courseXYZ`.
     * @principle Restricts all access to a user's own data tree and validates relational integrity on write.
     */
    match /users/{userId}/courses/{courseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if createsOwnChild(userId);
      allow update: if isExistingOwner(userId) && updatesOwnChild();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages modules within a user's course.
     * @path /users/{userId}/courses/{courseId}/modules/{moduleId}
     * @allow A user (auth.uid='user123') can (create) a module for their own course.
     * @deny A user (auth.uid='user123') cannot (update) a module in another user's course.
     * @principle Access is inherited from the parent document's ownership. Enforces path consistency.
     */
    match /users/{userId}/courses/{courseId}/modules/{moduleId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && createsNestedChild(courseId, 'courseId');
      allow update: if isExistingOwner(userId) && updatesNestedChild('courseId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages lessons within a course module.
     * @path /users/{userId}/courses/{courseId}/modules/{moduleId}/lessons/{lessonId}
     * @allow A user (auth.uid='user123') can (get) a lesson from a module in their own course.
     * @deny A user (auth.uid='user123') cannot (list) lessons from another user's course.
     * @principle Access is inherited from the parent document's ownership. Enforces path consistency.
     */
    match /users/{userId}/courses/{courseId}/modules/{moduleId}/lessons/{lessonId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && createsNestedChild(moduleId, 'moduleId');
      allow update: if isExistingOwner(userId) && updatesNestedChild('moduleId');
      allow delete: if isExistingOwner(userId);
    }
  }
}